<!DOCTYPE HTML>
<html lang>
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: io.github.ai4ci.output, class: CSVMapper">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">package io.github.ai4ci.output;</span>
<span class="source-line-no">002</span><span id="line-2"></span>
<span class="source-line-no">003</span><span id="line-3">import java.util.Arrays;</span>
<span class="source-line-no">004</span><span id="line-4">import java.util.stream.IntStream;</span>
<span class="source-line-no">005</span><span id="line-5">import java.util.stream.Stream;</span>
<span class="source-line-no">006</span><span id="line-6"></span>
<span class="source-line-no">007</span><span id="line-7">import org.mapstruct.Builder;</span>
<span class="source-line-no">008</span><span id="line-8">import org.mapstruct.Mapper;</span>
<span class="source-line-no">009</span><span id="line-9">import org.mapstruct.Mapping;</span>
<span class="source-line-no">010</span><span id="line-10">import org.mapstruct.NullValueCheckStrategy;</span>
<span class="source-line-no">011</span><span id="line-11">import org.mapstruct.NullValuePropertyMappingStrategy;</span>
<span class="source-line-no">012</span><span id="line-12">import org.mapstruct.factory.Mappers;</span>
<span class="source-line-no">013</span><span id="line-13"></span>
<span class="source-line-no">014</span><span id="line-14">import io.github.ai4ci.abm.Calibration;</span>
<span class="source-line-no">015</span><span id="line-15">import io.github.ai4ci.abm.Contact;</span>
<span class="source-line-no">016</span><span id="line-16">import io.github.ai4ci.abm.Outbreak;</span>
<span class="source-line-no">017</span><span id="line-17">import io.github.ai4ci.abm.OutbreakBaseline;</span>
<span class="source-line-no">018</span><span id="line-18">import io.github.ai4ci.abm.OutbreakHistory;</span>
<span class="source-line-no">019</span><span id="line-19">import io.github.ai4ci.abm.OutbreakState;</span>
<span class="source-line-no">020</span><span id="line-20">import io.github.ai4ci.abm.Person;</span>
<span class="source-line-no">021</span><span id="line-21">import io.github.ai4ci.abm.PersonBaseline;</span>
<span class="source-line-no">022</span><span id="line-22">import io.github.ai4ci.abm.PersonDemographic;</span>
<span class="source-line-no">023</span><span id="line-23">import io.github.ai4ci.abm.PersonHistory;</span>
<span class="source-line-no">024</span><span id="line-24">import io.github.ai4ci.abm.PersonState;</span>
<span class="source-line-no">025</span><span id="line-25">import io.github.ai4ci.abm.TestResult;</span>
<span class="source-line-no">026</span><span id="line-26">import io.github.ai4ci.util.Binomial;</span>
<span class="source-line-no">027</span><span id="line-27"></span>
<span class="source-line-no">028</span><span id="line-28">/**</span>
<span class="source-line-no">029</span><span id="line-29"> * Mapper responsible for converting domain model objects into CSV DTOs.</span>
<span class="source-line-no">030</span><span id="line-30"> *</span>
<span class="source-line-no">031</span><span id="line-31"> * &lt;p&gt;</span>
<span class="source-line-no">032</span><span id="line-32"> * This abstract MapStruct mapper centralises the logic used to produce</span>
<span class="source-line-no">033</span><span id="line-33"> * CSV-friendly immutable transfer objects for reporting and downstream</span>
<span class="source-line-no">034</span><span id="line-34"> * analysis. Typical inputs are outbreak, person and history objects and outputs</span>
<span class="source-line-no">035</span><span id="line-35"> * are immutable CSV types defined in this package (for example</span>
<span class="source-line-no">036</span><span id="line-36"> * {@code ImmutableOutbreakCSV}, {@code ImmutableLineListCSV}).</span>
<span class="source-line-no">037</span><span id="line-37"> * &lt;/p&gt;</span>
<span class="source-line-no">038</span><span id="line-38"> *</span>
<span class="source-line-no">039</span><span id="line-39"> * &lt;p&gt;</span>
<span class="source-line-no">040</span><span id="line-40"> * Downstream uses: the CSV DTOs produced by this mapper are consumed by</span>
<span class="source-line-no">041</span><span id="line-41"> * reporting and analysis routines external to the core simulation. See the</span>
<span class="source-line-no">042</span><span id="line-42"> * {@code io.github.ai4ci.output} package for the DTO types and the</span>
<span class="source-line-no">043</span><span id="line-43"> * {@link io.github.ai4ci.abm.Outbreak} and {@link Person} classes which provide</span>
<span class="source-line-no">044</span><span id="line-44"> * the inputs to the mapper.</span>
<span class="source-line-no">045</span><span id="line-45"> * &lt;/p&gt;</span>
<span class="source-line-no">046</span><span id="line-46"> *</span>
<span class="source-line-no">047</span><span id="line-47"> * @author Rob Challen</span>
<span class="source-line-no">048</span><span id="line-48"> */</span>
<span class="source-line-no">049</span><span id="line-49">@Mapper(</span>
<span class="source-line-no">050</span><span id="line-50">                builder = @Builder(buildMethod = "build"),</span>
<span class="source-line-no">051</span><span id="line-51">                nullValueCheckStrategy = NullValueCheckStrategy.ALWAYS,</span>
<span class="source-line-no">052</span><span id="line-52">                nullValuePropertyMappingStrategy = NullValuePropertyMappingStrategy.IGNORE,</span>
<span class="source-line-no">053</span><span id="line-53">                imports = { Calibration.class }</span>
<span class="source-line-no">054</span><span id="line-54">)</span>
<span class="source-line-no">055</span><span id="line-55">public abstract class CSVMapper {</span>
<span class="source-line-no">056</span><span id="line-56"></span>
<span class="source-line-no">057</span><span id="line-57">        /**</span>
<span class="source-line-no">058</span><span id="line-58">         * Shared mapper instance obtained from MapStruct. Use this to access the</span>
<span class="source-line-no">059</span><span id="line-59">         * mapping functions from elsewhere in the codebase.</span>
<span class="source-line-no">060</span><span id="line-60">         */</span>
<span class="source-line-no">061</span><span id="line-61">        public static CSVMapper INSTANCE = Mappers.getMapper(CSVMapper.class);</span>
<span class="source-line-no">062</span><span id="line-62"></span>
<span class="source-line-no">063</span><span id="line-63">        /**</span>
<span class="source-line-no">064</span><span id="line-64">         * Convert a project Binomial object to a probability for CSV output.</span>
<span class="source-line-no">065</span><span id="line-65">         *</span>
<span class="source-line-no">066</span><span id="line-66">         * @param binom the Binomial to convert</span>
<span class="source-line-no">067</span><span id="line-67">         * @return the probability represented by the Binomial</span>
<span class="source-line-no">068</span><span id="line-68">         */</span>
<span class="source-line-no">069</span><span id="line-69">        public double fromBinom(Binomial binom) {</span>
<span class="source-line-no">070</span><span id="line-70">                return binom.probability();</span>
<span class="source-line-no">071</span><span id="line-71">        }</span>
<span class="source-line-no">072</span><span id="line-72"></span>
<span class="source-line-no">073</span><span id="line-73">        /**</span>
<span class="source-line-no">074</span><span id="line-74">         * Produce an infectivity profile CSV stream for the supplied outbreak. Each</span>
<span class="source-line-no">075</span><span id="line-75">         * element represents the probability of transmission at a given time lag</span>
<span class="source-line-no">076</span><span id="line-76">         * tau.</span>
<span class="source-line-no">077</span><span id="line-77">         *</span>
<span class="source-line-no">078</span><span id="line-78">         * @param outbreak the outbreak from which to derive the profile</span>
<span class="source-line-no">079</span><span id="line-79">         * @return stream of {@link InfectivityProfileCSV} records</span>
<span class="source-line-no">080</span><span id="line-80">         */</span>
<span class="source-line-no">081</span><span id="line-81">        public Stream&lt;InfectivityProfileCSV&gt; infectivityProfile(Outbreak outbreak) {</span>
<span class="source-line-no">082</span><span id="line-82">                var dd = outbreak.getBaseline().getInfectivityProfile();</span>
<span class="source-line-no">083</span><span id="line-83">                return IntStream.range(0, (int) dd.size())</span>
<span class="source-line-no">084</span><span id="line-84">                                .mapToObj(i -&gt; this.toIP(outbreak, i, dd.density(i)));</span>
<span class="source-line-no">085</span><span id="line-85">        }</span>
<span class="source-line-no">086</span><span id="line-86"></span>
<span class="source-line-no">087</span><span id="line-87">        /**</span>
<span class="source-line-no">088</span><span id="line-88">         * Map outbreak behaviour counts to CSV DTOs.</span>
<span class="source-line-no">089</span><span id="line-89">         *</span>
<span class="source-line-no">090</span><span id="line-90">         * @param outbreak the outbreak state providing behaviour counts</span>
<span class="source-line-no">091</span><span id="line-91">         * @return stream of behaviour count CSV records</span>
<span class="source-line-no">092</span><span id="line-92">         */</span>
<span class="source-line-no">093</span><span id="line-93">        public Stream&lt;OutbreakBehaviourCountCSV&gt; toBehaviourCSV(Outbreak outbreak) {</span>
<span class="source-line-no">094</span><span id="line-94">                var cs = outbreak.getCurrentState();</span>
<span class="source-line-no">095</span><span id="line-95">                return cs.getBehaviourCounts().entrySet().stream()</span>
<span class="source-line-no">096</span><span id="line-96">                                .map(kv -&gt; this.toBehaviourCSV(cs, kv.getKey(), kv.getValue()));</span>
<span class="source-line-no">097</span><span id="line-97">        }</span>
<span class="source-line-no">098</span><span id="line-98"></span>
<span class="source-line-no">099</span><span id="line-99">        /**</span>
<span class="source-line-no">100</span><span id="line-100">         * Map outbreak behaviour counts to CSV DTOs.</span>
<span class="source-line-no">101</span><span id="line-101">         *</span>
<span class="source-line-no">102</span><span id="line-102">         * @param state     outbreak state providing behaviour counts</span>
<span class="source-line-no">103</span><span id="line-103">         * @param behaviour the type of behaviour (e.g. "home", "work", "other")</span>
<span class="source-line-no">104</span><span id="line-104">         * @param count     the count of agents exhibiting this behaviour in the</span>
<span class="source-line-no">105</span><span id="line-105">         *                  outbreak state</span>
<span class="source-line-no">106</span><span id="line-106">         * @return CSV DTO for the behaviour count</span>
<span class="source-line-no">107</span><span id="line-107">         */</span>
<span class="source-line-no">108</span><span id="line-108">        public abstract ImmutableOutbreakBehaviourCountCSV toBehaviourCSV(</span>
<span class="source-line-no">109</span><span id="line-109">                        OutbreakState state, String behaviour, Long count</span>
<span class="source-line-no">110</span><span id="line-110">        );</span>
<span class="source-line-no">111</span><span id="line-111"></span>
<span class="source-line-no">112</span><span id="line-112">        /**</span>
<span class="source-line-no">113</span><span id="line-113">         * Map outbreak contact counts to CSV DTOs.</span>
<span class="source-line-no">114</span><span id="line-114">         *</span>
<span class="source-line-no">115</span><span id="line-115">         * @param t outbreak instance containing contact counts</span>
<span class="source-line-no">116</span><span id="line-116">         * @return stream of contact count CSV records</span>
<span class="source-line-no">117</span><span id="line-117">         */</span>
<span class="source-line-no">118</span><span id="line-118">        public Stream&lt;OutbreakContactCountCSV&gt; toContactCSV(Outbreak t) {</span>
<span class="source-line-no">119</span><span id="line-119">                var cs = t.getCurrentState();</span>
<span class="source-line-no">120</span><span id="line-120">                return cs.getContactCounts().entrySet().stream()</span>
<span class="source-line-no">121</span><span id="line-121">                                .map(kv -&gt; this.toContactCSV(cs, kv.getKey(), kv.getValue()));</span>
<span class="source-line-no">122</span><span id="line-122">        }</span>
<span class="source-line-no">123</span><span id="line-123"></span>
<span class="source-line-no">124</span><span id="line-124">        /**</span>
<span class="source-line-no">125</span><span id="line-125">         * Map outbreak contact counts to CSV DTOs.</span>
<span class="source-line-no">126</span><span id="line-126">         *</span>
<span class="source-line-no">127</span><span id="line-127">         * @param state    outbreak state providing contact counts</span>
<span class="source-line-no">128</span><span id="line-128">         * @param contacts the type of contacts (e.g. "home", "work", "other")</span>
<span class="source-line-no">129</span><span id="line-129">         * @param count    the count of contacts of this type in the outbreak state</span>
<span class="source-line-no">130</span><span id="line-130">         * @return CSV DTO for the contact count</span>
<span class="source-line-no">131</span><span id="line-131">         */</span>
<span class="source-line-no">132</span><span id="line-132">        public abstract ImmutableOutbreakContactCountCSV toContactCSV(</span>
<span class="source-line-no">133</span><span id="line-133">                        OutbreakState state, Long contacts, Long count</span>
<span class="source-line-no">134</span><span id="line-134">        );</span>
<span class="source-line-no">135</span><span id="line-135"></span>
<span class="source-line-no">136</span><span id="line-136">        /**</span>
<span class="source-line-no">137</span><span id="line-137">         * Convert a person's contacts (from their current history snapshot) into CSV</span>
<span class="source-line-no">138</span><span id="line-138">         * contact records. Only contacts where this person is participant1 are</span>
<span class="source-line-no">139</span><span id="line-139">         * exported.</span>
<span class="source-line-no">140</span><span id="line-140">         *</span>
<span class="source-line-no">141</span><span id="line-141">         * @param person the person whose contacts to export</span>
<span class="source-line-no">142</span><span id="line-142">         * @return stream of contact CSV records</span>
<span class="source-line-no">143</span><span id="line-143">         */</span>
<span class="source-line-no">144</span><span id="line-144">        public Stream&lt;ImmutableContactCSV&gt; toContacts(Person person) {</span>
<span class="source-line-no">145</span><span id="line-145">                return person.getCurrentHistory().stream().flatMap(</span>
<span class="source-line-no">146</span><span id="line-146">                                ph -&gt; Arrays.stream(ph.getTodaysContacts())</span>
<span class="source-line-no">147</span><span id="line-147">                                                .filter(c -&gt; c.getParticipant1Id() == person.getId())</span>
<span class="source-line-no">148</span><span id="line-148">                                                .map(c -&gt; this.toCSV(ph, c))</span>
<span class="source-line-no">149</span><span id="line-149">                );</span>
<span class="source-line-no">150</span><span id="line-150">        }</span>
<span class="source-line-no">151</span><span id="line-151"></span>
<span class="source-line-no">152</span><span id="line-152">        /**</span>
<span class="source-line-no">153</span><span id="line-153">         * Map debug parameters for an outbreak into a CSV DTO. The mapping includes</span>
<span class="source-line-no">154</span><span id="line-154">         * calibrated values derived via {@link Calibration}.</span>
<span class="source-line-no">155</span><span id="line-155">         *</span>
<span class="source-line-no">156</span><span id="line-156">         * @param outbreak the outbreak</span>
<span class="source-line-no">157</span><span id="line-157">         * @param baseline outbreak baseline parameters</span>
<span class="source-line-no">158</span><span id="line-158">         * @return CSV DTO containing debug parameters</span>
<span class="source-line-no">159</span><span id="line-159">         */</span>
<span class="source-line-no">160</span><span id="line-160">        @Mapping(</span>
<span class="source-line-no">161</span><span id="line-161">                        target = "averageContactDegree",</span>
<span class="source-line-no">162</span><span id="line-162">                        expression = "java(Calibration.averageContactDegree(outbreak))"</span>
<span class="source-line-no">163</span><span id="line-163">        )</span>
<span class="source-line-no">164</span><span id="line-164">        @Mapping(</span>
<span class="source-line-no">165</span><span id="line-165">                        target = "percolationThreshold",</span>
<span class="source-line-no">166</span><span id="line-166">                        expression = "java(Calibration.percolationThreshold(outbreak))"</span>
<span class="source-line-no">167</span><span id="line-167">        )</span>
<span class="source-line-no">168</span><span id="line-168">        public abstract ImmutableDebugParametersCSV toCSV(</span>
<span class="source-line-no">169</span><span id="line-169">                        Outbreak outbreak, OutbreakBaseline baseline</span>
<span class="source-line-no">170</span><span id="line-170">        );</span>
<span class="source-line-no">171</span><span id="line-171"></span>
<span class="source-line-no">172</span><span id="line-172">        /**</span>
<span class="source-line-no">173</span><span id="line-173">         * Convert an outbreak history record to a CSV DTO. The observation time is</span>
<span class="source-line-no">174</span><span id="line-174">         * taken from the entity current state time.</span>
<span class="source-line-no">175</span><span id="line-175">         *</span>
<span class="source-line-no">176</span><span id="line-176">         * @param history outbreak history record</span>
<span class="source-line-no">177</span><span id="line-177">         * @return CSV DTO for the outbreak history record</span>
<span class="source-line-no">178</span><span id="line-178">         */</span>
<span class="source-line-no">179</span><span id="line-179">        @Mapping(</span>
<span class="source-line-no">180</span><span id="line-180">                        target = "observationTime",</span>
<span class="source-line-no">181</span><span id="line-181">                        source = "entity.currentState.time"</span>
<span class="source-line-no">182</span><span id="line-182">        )</span>
<span class="source-line-no">183</span><span id="line-183">        public abstract ImmutableOutbreakHistoryCSV toCSV(OutbreakHistory history);</span>
<span class="source-line-no">184</span><span id="line-184"></span>
<span class="source-line-no">185</span><span id="line-185">        /**</span>
<span class="source-line-no">186</span><span id="line-186">         * Convert an outbreak state into a CSV DTO representing the outbreak.</span>
<span class="source-line-no">187</span><span id="line-187">         *</span>
<span class="source-line-no">188</span><span id="line-188">         * @param state the outbreak state</span>
<span class="source-line-no">189</span><span id="line-189">         * @return CSV DTO for the outbreak</span>
<span class="source-line-no">190</span><span id="line-190">         */</span>
<span class="source-line-no">191</span><span id="line-191">        public abstract ImmutableOutbreakCSV toCSV(OutbreakState state);</span>
<span class="source-line-no">192</span><span id="line-192"></span>
<span class="source-line-no">193</span><span id="line-193">        /**</span>
<span class="source-line-no">194</span><span id="line-194">         * Map a person and their demographic and baseline information to a CSV DTO</span>
<span class="source-line-no">195</span><span id="line-195">         * for demographic exports. The mapper extracts the person id and demographic</span>
<span class="source-line-no">196</span><span id="line-196">         * attributes for inclusion in the CSV.</span>
<span class="source-line-no">197</span><span id="line-197">         *</span>
<span class="source-line-no">198</span><span id="line-198">         * @param person   the person to map</span>
<span class="source-line-no">199</span><span id="line-199">         * @param demog    the person's demographic information</span>
<span class="source-line-no">200</span><span id="line-200">         * @param baseline the person's baseline information</span>
<span class="source-line-no">201</span><span id="line-201">         * @return CSV DTO for the person's demographics</span>
<span class="source-line-no">202</span><span id="line-202">         */</span>
<span class="source-line-no">203</span><span id="line-203">        protected abstract ImmutablePersonDemographicsCSV toCSV(</span>
<span class="source-line-no">204</span><span id="line-204">                        Person person, PersonDemographic demog, PersonBaseline baseline</span>
<span class="source-line-no">205</span><span id="line-205">        );</span>
<span class="source-line-no">206</span><span id="line-206"></span>
<span class="source-line-no">207</span><span id="line-207">        /**</span>
<span class="source-line-no">208</span><span id="line-208">         * Map a person history and contact to a CSV DTO for contact exports. The</span>
<span class="source-line-no">209</span><span id="line-209">         * mapper extracts the person id and contact participant ids for inclusion in</span>
<span class="source-line-no">210</span><span id="line-210">         * the CSV.</span>
<span class="source-line-no">211</span><span id="line-211">         *</span>
<span class="source-line-no">212</span><span id="line-212">         * @param person  the person whose history is being mapped</span>
<span class="source-line-no">213</span><span id="line-213">         * @param contact the contact to map, which should involve the person as</span>
<span class="source-line-no">214</span><span id="line-214">         *                participant1</span>
<span class="source-line-no">215</span><span id="line-215">         * @return CSV DTO for the contact</span>
<span class="source-line-no">216</span><span id="line-216">         */</span>
<span class="source-line-no">217</span><span id="line-217">        @Mapping(</span>
<span class="source-line-no">218</span><span id="line-218">                        target = "id",</span>
<span class="source-line-no">219</span><span id="line-219">                        source = "contact.participant1Id"</span>
<span class="source-line-no">220</span><span id="line-220">        )</span>
<span class="source-line-no">221</span><span id="line-221">        @Mapping(</span>
<span class="source-line-no">222</span><span id="line-222">                        target = "contactId",</span>
<span class="source-line-no">223</span><span id="line-223">                        source = "contact.participant2Id"</span>
<span class="source-line-no">224</span><span id="line-224">        )</span>
<span class="source-line-no">225</span><span id="line-225">        protected abstract ImmutableContactCSV toCSV(</span>
<span class="source-line-no">226</span><span id="line-226">                        PersonHistory person, Contact contact</span>
<span class="source-line-no">227</span><span id="line-227">        );</span>
<span class="source-line-no">228</span><span id="line-228"></span>
<span class="source-line-no">229</span><span id="line-229">        /**</span>
<span class="source-line-no">230</span><span id="line-230">         * Map a person state to a line list CSV DTO. The mapper extracts the person</span>
<span class="source-line-no">231</span><span id="line-231">         * id and risk model log odds for inclusion in the line list.</span>
<span class="source-line-no">232</span><span id="line-232">         *</span>
<span class="source-line-no">233</span><span id="line-233">         * @param state the person state to map</span>
<span class="source-line-no">234</span><span id="line-234">         * @return line list CSV DTO</span>
<span class="source-line-no">235</span><span id="line-235">         */</span>
<span class="source-line-no">236</span><span id="line-236">        @Mapping(</span>
<span class="source-line-no">237</span><span id="line-237">                        target = "personId",</span>
<span class="source-line-no">238</span><span id="line-238">                        source = "entity.id"</span>
<span class="source-line-no">239</span><span id="line-239">        )</span>
<span class="source-line-no">240</span><span id="line-240">        @Mapping(</span>
<span class="source-line-no">241</span><span id="line-241">                        target = "logOddsInfectiousToday",</span>
<span class="source-line-no">242</span><span id="line-242">                        source = "riskModel.logOddsInfectiousToday"</span>
<span class="source-line-no">243</span><span id="line-243">        )</span>
<span class="source-line-no">244</span><span id="line-244">        public abstract ImmutableLineListCSV toCSV(PersonState state);</span>
<span class="source-line-no">245</span><span id="line-245"></span>
<span class="source-line-no">246</span><span id="line-246">        /**</span>
<span class="source-line-no">247</span><span id="line-247">         * Map a test result and corresponding person history to a CSV DTO for test</span>
<span class="source-line-no">248</span><span id="line-248">         * results. The mapper extracts the person id and test time from the person</span>
<span class="source-line-no">249</span><span id="line-249">         * history, and the test name from the test result parameters.</span>
<span class="source-line-no">250</span><span id="line-250">         *</span>
<span class="source-line-no">251</span><span id="line-251">         * @param t  the test result to map</span>
<span class="source-line-no">252</span><span id="line-252">         * @param ph the corresponding person history providing context for the test</span>
<span class="source-line-no">253</span><span id="line-253">         * @return CSV DTO for the test result</span>
<span class="source-line-no">254</span><span id="line-254">         */</span>
<span class="source-line-no">255</span><span id="line-255">        @Mapping(</span>
<span class="source-line-no">256</span><span id="line-256">                        target = "time",</span>
<span class="source-line-no">257</span><span id="line-257">                        source = "ph.time"</span>
<span class="source-line-no">258</span><span id="line-258">        )</span>
<span class="source-line-no">259</span><span id="line-259">        @Mapping(</span>
<span class="source-line-no">260</span><span id="line-260">                        target = "id",</span>
<span class="source-line-no">261</span><span id="line-261">                        source = "ph.entity.id"</span>
<span class="source-line-no">262</span><span id="line-262">        )</span>
<span class="source-line-no">263</span><span id="line-263">        @Mapping(</span>
<span class="source-line-no">264</span><span id="line-264">                        target = "type",</span>
<span class="source-line-no">265</span><span id="line-265">                        source = "t.testParams.testName"</span>
<span class="source-line-no">266</span><span id="line-266">        )</span>
<span class="source-line-no">267</span><span id="line-267">        @Mapping(</span>
<span class="source-line-no">268</span><span id="line-268">                        target = "sampleTime",</span>
<span class="source-line-no">269</span><span id="line-269">                        source = "t.time"</span>
<span class="source-line-no">270</span><span id="line-270">        )</span>
<span class="source-line-no">271</span><span id="line-271">        public abstract ImmutablePersonTestsCSV toCSV(</span>
<span class="source-line-no">272</span><span id="line-272">                        TestResult t, PersonHistory ph</span>
<span class="source-line-no">273</span><span id="line-273">        );</span>
<span class="source-line-no">274</span><span id="line-274"></span>
<span class="source-line-no">275</span><span id="line-275">        /**</span>
<span class="source-line-no">276</span><span id="line-276">         * Convenience: map person demographics to the CSV DTO used for demographic</span>
<span class="source-line-no">277</span><span id="line-277">         * exports.</span>
<span class="source-line-no">278</span><span id="line-278">         *</span>
<span class="source-line-no">279</span><span id="line-279">         * @param person the person whose demographics to export</span>
<span class="source-line-no">280</span><span id="line-280">         * @return demographic CSV DTO</span>
<span class="source-line-no">281</span><span id="line-281">         */</span>
<span class="source-line-no">282</span><span id="line-282">        public ImmutablePersonDemographicsCSV toDemog(Person person) {</span>
<span class="source-line-no">283</span><span id="line-283">                return this.toCSV(person, person.getDemographic(), person.getBaseline());</span>
<span class="source-line-no">284</span><span id="line-284">        }</span>
<span class="source-line-no">285</span><span id="line-285"></span>
<span class="source-line-no">286</span><span id="line-286">        /**</span>
<span class="source-line-no">287</span><span id="line-287">         * Map the current outbreak state to a CSV DTO representing the final state</span>
<span class="source-line-no">288</span><span id="line-288">         * of the outbreak. This is used for final state exports and includes</span>
<span class="source-line-no">289</span><span id="line-289">         * cumulative counts and other summary statistics.</span>
<span class="source-line-no">290</span><span id="line-290">         *</span>
<span class="source-line-no">291</span><span id="line-291">         * @param currentState the current outbreak state</span>
<span class="source-line-no">292</span><span id="line-292">         * @return CSV DTO for the final outbreak state</span>
<span class="source-line-no">293</span><span id="line-293">         */</span>
<span class="source-line-no">294</span><span id="line-294">        public abstract ImmutableOutbreakFinalStateCSV toFinalCSV(</span>
<span class="source-line-no">295</span><span id="line-295">                        OutbreakState currentState</span>
<span class="source-line-no">296</span><span id="line-296">        );</span>
<span class="source-line-no">297</span><span id="line-297"></span>
<span class="source-line-no">298</span><span id="line-298">        /**</span>
<span class="source-line-no">299</span><span id="line-299">         * Map an outbreak's infectivity profile to a CSV DTO. Each record represents</span>
<span class="source-line-no">300</span><span id="line-300">         * the probability of transmission at a given time lag tau.</span>
<span class="source-line-no">301</span><span id="line-301">         *</span>
<span class="source-line-no">302</span><span id="line-302">         * @param outbreak    the outbreak from which to derive the profile</span>
<span class="source-line-no">303</span><span id="line-303">         * @param tau         the time lag for this profile entry</span>
<span class="source-line-no">304</span><span id="line-304">         * @param probability the probability of transmission at this time lag</span>
<span class="source-line-no">305</span><span id="line-305">         * @return CSV DTO for the infectivity profile entry</span>
<span class="source-line-no">306</span><span id="line-306">         */</span>
<span class="source-line-no">307</span><span id="line-307">        protected abstract ImmutableInfectivityProfileCSV toIP(</span>
<span class="source-line-no">308</span><span id="line-308">                        Outbreak outbreak, int tau, double probability</span>
<span class="source-line-no">309</span><span id="line-309">        );</span>
<span class="source-line-no">310</span><span id="line-310"></span>
<span class="source-line-no">311</span><span id="line-311">        /**</span>
<span class="source-line-no">312</span><span id="line-312">         * Map an outbreak to a CSV DTO representing the outbreak configuration. This</span>
<span class="source-line-no">313</span><span id="line-313">         * includes parameters from the outbreak baseline and other setup parameters</span>
<span class="source-line-no">314</span><span id="line-314">         * that define the initial conditions of the outbreak.</span>
<span class="source-line-no">315</span><span id="line-315">         *</span>
<span class="source-line-no">316</span><span id="line-316">         * @param outbreak the outbreak to map</span>
<span class="source-line-no">317</span><span id="line-317">         * @return CSV DTO for the outbreak configuration</span>
<span class="source-line-no">318</span><span id="line-318">         */</span>
<span class="source-line-no">319</span><span id="line-319">        public abstract ImmutableOutbreakConfigurationJson toJson(Outbreak outbreak);</span>
<span class="source-line-no">320</span><span id="line-320">}</span>




























































</pre>
</div>
</main>
</body>
</html>
